<!DOCTYPE html>
<html lang="it">
    <head>
        <title>SVM Javascript</title>
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,700&display=swap" rel="stylesheet">
        <link type="text/css" href="./jqueryui/css/ui-lightness/jquery-ui-1.8.21.custom.css" rel="Stylesheet" />
        <link type="text/css" rel="stylesheet" href="style/style.css"/>
        <link type="text/css" rel="stylesheet" href="style/radio_button.css"/>
        <link type="text/css" rel="stylesheet" href="style/progress_bar.css"/>
        <script type="text/javascript" src="./jqueryui/js/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="./jqueryui/js/jquery-ui-1.8.21.custom.min.js"></script>
        <script src="./npg_include/npgmain.js"></script>
        <script src="./npg_include/drawTest.js"></script>

        <script src="./lib/stats.js"></script>
        <script src="./lib/utils.js"></script>
        <script src="./lib/kernels.js"></script>
        <script src="./lib/input_transformations.js"></script>

        <script src="./js/kmeans.js"></script>
        <script src="./lib/svm.js"></script>
        <script src="./lib/svmo.js"></script>

        <script type="text/javascript" src="./js/generator.js"></script>

        <!-- Declaration and initialization -->
        <script type="text/javascript">

        /*
        This demo includes npg library (notpygamejs) that I wrote a while ago. It can
        be found on my Github page (https://github.com/karpathy/notpygamejs). It's a
        quick and dirty canvas wrapper that has some helped functions I use often.
        It's main use is to contain a main loop and expose methods update(), draw(),
        as well as some events keyUp(), mouseClick() etc.
        */

        let N = 100; //number of data points
        let Ntest = 100;
        let training_placeholder = "training";
        let test_placeholder = "test";
        let equation_placeholder = "formula";
        let textType = "text/plain";
        let jsonType = "application/json";
        let data = new Array(N);
        let labels = new Array(N);
        let datatest = new Array(N);
        let labelstest = new Array(N);
        let dataOLD = [];
        let labelsOLD = [];
        let wb; // weights and offset structure
        let ss= 40.0; // scaling factor for drawing
        let svm= new svmjs.SVM();
        let svmo = new svmojs.SVMO();

        let rbfKernelSigma = 0.5;
        let svmC = 1.0;
        let memo = false;
        let input_transformation = false;
        let input_functions = [];

        let kernelid= 2;
        let Degree = 1;
        let Influence = 0;
        let ssca = false;
        let ub = 0.5;
        let K = 1; //for KNN
        let P = 2; //for minkowski
        let v; //array of variances
        let distanceid = 0; //for distances in KNN evalutations
        let datasetID = 1; //initially random
        let Epsilon = 0.1; //for rbf function evaluation
        let drawKmeansPoints = false; //only for the drawing thing
        let Km1 = 3; //K for kmeans
        let Km2 = 3; //K for kmeans
        let means;
        let KMdata = false; //use or not Kmeans as data
        let KMdataUser = false;
        let useTest = false; //show the tests
        let density = 2; //drawing canvas points
        let dataset_modified = true;
        let link = "";
        let time = 0;
        let karpathy = true;

        let canvasResult = "canvasResult";
        let canvasData = "canvasData";

        let info_tab = true;
        let draw_tab = true;
        let statistics_tab = true;
        let options_tab = true;

        let user_data = [];
        let user_labels = [];

        let use_timer = true;
        let updateFrequency = 100;
        let stepsFrequency = 10;
        let timer = {
            stepsFrequency: stepsFrequency,
            updateFrequency: updateFrequency
        };

        </script>

        <!-- Dataset - Retrain - init -->
        <script type="text/javascript">
        function setDataSet(id) {
            if(datasetID !== id){
                datasetID = id;
                dataset_modified = true;
            }
            if(id===-1){
                data = user_data;
                labels = user_labels;
                N = user_data.length;
                console.info(N);
                Ntest = 0;
            }
            else if(id===1){
                let res = randomData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===2){
                let res = circleData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===3){
                let res = exclusiveOrData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===4){
                let res = gaussianData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===5){
                let res = spiralData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===6){
                let res = circleMultipleData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===7){
                let res = stripesVData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===8){
                let res = stripesHData(N);
                data = res.data;
                labels = res.labels;
            }
            if(id!==-1)
                setTrainingSet(datasetID);
        }
        function setTrainingSet(id) {
            if(id===1){
                let res = randomData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===2){
                let res = circleData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===3){
                let res = exclusiveOrData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===4){
                let res = gaussianData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===5){
                let res = spiralData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===6){
                let res = circleMultipleData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===7){
                let res = stripesVData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===8){
                let res = stripesHData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
        }

        function resetStatsSVM() {
            let nSV = document.getElementById("nSV");
            nSV.classList.remove("red");
            nSV.classList.remove("yellow");
            nSV.classList.remove("green");
            nSV.innerHTML = "---";
            document.getElementById("formulaL").innerHTML = "---";
            document.getElementById("nDim").innerHTML = "---";
            document.getElementById("time").innerHTML = "---";
            document.getElementById("scoreboard").innerHTML = "---";

        }
        function updateStatsSVM() {
            if(karpathy && use_timer) return;
            //support vector
            let n = countSV(svm,data);
            let nSV = document.getElementById("nSV");
            nSV.innerHTML = n+"/"+data.length;
            if((n/data.length)>0.5) nSV.classList.add("red");
            else if((n/data.length)>0.25) nSV.classList.add("yellow");
            else nSV.classList.add("green");

            if( kernelid===2 && Degree === 1) { //solo per il poly con grado 1
                wb = svm.getWeights();
                //formula linear
                let formula = svm.getFormulaLinear(wb);
                document.getElementById("formulaL").innerHTML = formula.html;
                document.getElementById("fakeInputFormula").value = formula.equation;
                document.getElementById("nDim").innerHTML = ""+wb.w.length;
            }
            else document.getElementById("nDim").innerHTML = "‚àû";

            if(time === undefined) return;
            //time
            if(time>1000) document.getElementById("time").innerHTML = (time/1000).toPrecision(3)+" s";
            else document.getElementById("time").innerHTML = time.toPrecision(3)+" ms";


        }

        function retrainSVM() {
            console.info("üêµ DATASET "+datasetID);
            if(input_transformation){
                for(let i=0;i<input_functions.length;i++)
                    console.info("üêß INPUT FUNCTION "+input_functions[i].name);
            }

            if(kernelid === 0) {
                kernelid = 2;
                Degree = 1;
                retrainSVM();
            }
            else if(kernelid === 1) {
                time = svm.train(data, labels, {
                    kernel: 'rbf',
                    rbfsigma: rbfKernelSigma,
                    C: svmC,
                    SSCA: ssca,
                    UB: ub,
                    memoize: memo,
                    karpathy: karpathy,
                    timer: timer,
                    });
                updateStatsSVM();
            }
            else if(kernelid === 2){
                time = svm.train(data, labels, {
                    kernel: 'poly',
                    degree: Degree,
                    influence: Influence,
                    C: svmC,
                    SSCA: ssca,
                    UB: ub,
                    memoize: memo,
                    input_functions: input_functions,
                    karpathy: karpathy,
                    timer: timer,
                    });
                updateStatsSVM();
            }
            else if(kernelid === 3){
                console.info("\tKNN: "+K);
                console.info("\tDISTANCE: "+distanceF.name);
                if(distanceid===0){
                    console.info("\tP = "+P);
                }
                else if(distanceid === 2){ //mahalanobis
                    v = variance(); //calcolo una volta sola per aggiornamento di data set
                }
            }
            else if(kernelid === 4){
                console.info("\tRBF");
            }
        }

        function myinit(){}
        function myinitTest(){}
        </script>

        <!-- K-Means -->
        <!--
        <script type="text/javascript">
        function KMEANS(data) {
            console.info("\tKMEANS");
            KMdataUser = false;
            drawKmeansPoints = true;
            let separated = separateData(data);
            let kmeans1 = new KMeans({
                canvas: document.getElementById('canvasData'),
                data: separated[0],
                k: Km1,
                p: 1
            });
            let kmeans2 = new KMeans({
                canvas: document.getElementById('canvasData'),
                data: separated[1],
                k: Km2,
                p: 1
            });

            means = new Array(2);
            means[0] = kmeans1.means;
            means[1] = kmeans2.means;
            return createNewData(means);
        }
        function resetKmeans() {
            means = new Array(2);
            means[0] = [];
            means[1] = [];
        }
        function cleanKmeans() {
            resetKmeans();
            execute();
        }
        function createNewData(means) {
            let L1,L2;
            L1 = means[0].length;
            L2 = means[1].length;

            let L = L1+L2;
            let newData = new Array(L);
            let newLabels = new Array(L);
            for(let i=0;i<L1;i++){
                newData[i] = means[0][i];
                newLabels[i] = 1;
            }
            for(let i=L1;i<L;i++) {
                newData[i] = means[1][i-L1];
                newLabels[i] = -1;
            }
            return {
                data: newData,
                labels: newLabels
            };
        }
        function separateData(data) {
            let res = new Array(2);
            res[0] = [];
            res[1] = [];
            for(let i=0;i<data.length;i++){
                if(labels[i]===1)
                    res[0].push(data[i]);
                else res[1].push(data[i]);
            }
            return res;
        }
        function shouldDrawKmeans(value) {
            drawKmeansPoints = value;
            hideUiThings();
            showUiThings();
        }
        </script>
        -->

        <!-- distances functions (minkowski, chebyshev, mahalanobis) -->
        <script type="text/javascript" src="js/distances.js"></script>

        <!-- evaluations functions (KNN and RBF) -->
        <script type="text/javascript" src="js/evaluations.js"></script>

        <!-- main functions -->
        <script type="text/javascript">
            function onLoad() {
                NPGinit(10,canvasData);
                drawTestInit(10,canvasResult);
                dataset_modified = false;
                clean();
                hideUiThings();
                showUiThings();
            }
            function loadConfig(json) {
                console.info("loadConfig()");
                N = json.N;
                Ntest = json.Ntest;
                datasetID = json.datasetID;
                data = json.data;
                labels = json.labels;
                datatest = json.datatest;
                labelstest = json.labelstest;
                use_timer = json.use_timer;
                input_transformation = json.input_transformation;

                if(input_transformation){
                    for(let i=0;i<json.inputs.length;i++) {
                        document.getElementById(json.inputs[i]).checked = true;
                    }
                    inputFunctionUpdate();
                }
                kernelid = json.kernelid;
                Degree = json.Degree;
                execute();
            }
            function execute() {
                if(N===0) return;
                // document.getElementById("getReady").play();
                console.clear();
                console.info("üî® EXECUTE");
                update();
                resetStatsSVM();
                moveProgressBar(0,100);
                setTimeout(function(){
                    moveProgressBar(25,400);
                    setTimeout(function(){
                        retrainSVM();
                        draw();
                        moveProgressBar(100,1000);
                        // document.getElementById("hereWeGo").play();
                    }, 400);
                },100);
                return 0;
            }
            function test() {
                console.info("üß™ TEST "+!useTest);
                useTest = !useTest;
                hideUiThings();
                showUiThings();
                if(useTest) {
                    // let app = ctx;
                    // ctx = ctxTest; //substitute
                    // ctx.lineWidth = 1;
                    drawTest(ctxTest);
                    // ctx = app; //return to normal
                }
                else{
                    draw();
                }
            }
            function update(){
                console.info("UPDATE");

                if(input_transformation) {
                    inputFunctionUpdate();
                }
                else input_functions = [];

                ssca = document.getElementById("ssca").checked;
                karpathy = document.getElementById("karpathy").checked;
                // use_timer = document.getElementById("use_timer").checked;

                if(use_timer){
                    timer = {
                        ctx : ctxTest,
                        updateFrequency: updateFrequency,
                        stepsFrequency: stepsFrequency
                    };
                }
                else{
                    timer = null;
                }

                let value = document.getElementById("kmdata").checked;

                let res;
                let algorithm = document.getElementById("calculate_kmeans_points").checked;
                let user = document.getElementById("user_kmeans_points").checked;

                if(algorithm){ //se √® selezionata l'opzione dell'algoritmo
                    resetKmeans();
                    KMdataUser = false;
                    res = KMEANS(data);
                    drawKmeansPoints = document.getElementById("draw_kmeans_points").checked;
                }
                else if(user){
                    if(!KMdataUser || (means[0] === undefined && means[1] === undefined)) {
                        resetKmeans();
                    }
                    if(means[0].length+means[1].length > 0) {
                        KMdataUser = true;
                        res = createNewData(means);
                        drawKmeansPoints = document.getElementById("draw_kmeans_points").checked;
                    }
                    else{
                        KMdata = false;
                        value = false;
                        document.getElementById("kmdata").checked = false;
                        drawKmeansPoints = false;
                        document.getElementById("draw_kmeans_points").checked = false;
                    }

                }
                else{ //se non √® stato scelto un metodo per i K-means non li disegno e non li uso come dati di training
                    drawKmeansPoints = false;
                    document.getElementById("draw_kmeans_points").checked = false;
                    KMdata = false;
                    document.getElementById("kmdata").checked = false;
                }

                //se √® stato modificato il dataset
                if(dataset_modified){
                    dataset_modified = false;
                    document.getElementById("kmdata").checked = false;
                    if(KMdata)
                        N = dataOLD.length;
                    else N = data.length;
                    KMdata = false;
                    console.info("RESET "+N);
                    setDataSet(datasetID);
                    resetKmeans();
                }
                else {
                    if (value !== KMdata) {
                        if (value) {
                            console.info("STORE data");
                            dataOLD = data;
                            labelsOLD = labels;
                        } else {
                            console.info("RESTORE data");
                            data = dataOLD;
                            labels = labelsOLD;
                        }
                    }
                    KMdata = value;
                    if (KMdata) {
                        console.info("OVERWRITE data");
                        data = res.data;
                        labels = res.labels;
                    }

                    //update limits
                    N = data.length;
                }
                //hide and show buttons/options
                hideUiThings();
                showUiThings();
            }

            function orderByProperty(prop) {
                let args = Array.prototype.slice.call(arguments, 1);
                return function (a, b) {
                    let equality = b[prop] - a[prop];
                    if (equality === 0 && arguments.length > 1) {
                        return orderByProperty.apply(null, args)(a, b);
                    }
                    return equality;
                };
            }
            function best() {
                resetStatsSVM();

                let best = "";
                let max = 0;
                let best_time = 0;
                let functions = document.getElementsByClassName("inputF");
                let app = [];
                for(let i=0;i<functions.length;i++){
                    let f = document.getElementById(functions[i].id);
                    if(f.checked)
                        app.push(functions[i]);
                }
                if(app.length>0) //almeno 1
                    functions = app;

                moveProgressBar(0,100);

                setTimeout(function(){

                    let measures =[];
                    let percentage = 0;

                    let i=0;
                    let id = setInterval(()=>{
                        if (i === functions.length) {
                            clearInterval(id);
                            document.getElementById(best).checked = true;
                            execute();
                            console.info("‚≠ê‚≠ê‚≠ê BEST: "+best+" ‚≠ê‚≠ê‚≠ê");
                            measures = measures.sort(orderByProperty('value', 'time'));
                            for(let i=0;i<measures.length;i++){
                                measures[i].time = 1/measures[i].time;
                            }
                            // console.table(measures);
                            let scoreboard = document.getElementById("scoreboard");
                            let html_table_scoreboard = "<table class=\"card card-1\" id='scoreboard_table'> <thead> <tr> <th colspan=\"3\">Input Tested Score</th> </tr> <tr><th>Input Function</th> <th>F-Measure</th> <th>Training Time</th></tr> </thead> <tbody>";
                            for(let i=0;i<measures.length;i++){

                                if(measures[i].value<0.5)
                                    html_table_scoreboard += "<tr style='color: var(--action-c-darker)'>";
                                else html_table_scoreboard+="<tr>";

                                if(i===0)
                                    html_table_scoreboard += "<tr style='color: var(--primary-c-accent)'>";


                                html_table_scoreboard +="<td><strong>"+measures[i].id+"</strong></td><td>"+(measures[i].value*100).toPrecision(5)+"%</td><td>"+measures[i].time.toPrecision(6)+" ms</td></tr>";
                            }
                            html_table_scoreboard += "</tbody></table>";
                            scoreboard.innerHTML=html_table_scoreboard;
                        } else {
                            percentage = (i+1)/functions.length*100;
                            moveProgressBar(percentage,100);
                            let f = document.getElementById(functions[i].id);
                            f.checked = true;
                            inputFunctionUpdate();
                            retrainSVM();
                            draw();
                            let values = [];
                            for(let i=0;i<N;i++) {
                                values.push(getValue(data[i]));
                            }
                            let stats = statisticEval(labels,values);

                            let app = {
                                value: stats.fMeasure,
                                id: f.id,
                                time: 1/time
                            };

                            measures.push(app);

                            if(stats.fMeasure>max){
                                max = stats.fMeasure;
                                best = f.id;
                                best_time = time;
                            }
                            else if(stats.fMeasure === max){
                                if(time<best_time){
                                    best = f.id;
                                    best_time = time;
                                }
                            }
                            f.checked = false;
                            i++;
                        }
                    }, 300);
                },100);
            }

            function inputFunctionUpdate(){
                let arrayF = [];
                if(document.getElementById("x2").checked) arrayF.push(fx2);
                if(document.getElementById("y2").checked) arrayF.push(fy2);
                if(document.getElementById("x3").checked) arrayF.push(fx3);
                if(document.getElementById("y3").checked) arrayF.push(fy3);

                if(document.getElementById("x2y2").checked) arrayF.push(fx2y2);
                if(document.getElementById("x2_y2").checked) arrayF.push(fx2_y2);

                if(document.getElementById("xy").checked) arrayF.push(fxy);

                if(document.getElementById("sinx").checked) arrayF.push(fsinx);
                if(document.getElementById("cosx").checked) arrayF.push(fcosx);

                if(document.getElementById("siny").checked) arrayF.push(fsiny);
                if(document.getElementById("cosy").checked) arrayF.push(fcosy);

                if(document.getElementById("sinxcosy").checked) arrayF.push(fsinxcosy);
                if(document.getElementById("sinycosx").checked) arrayF.push(fsinycosx);

                if(document.getElementById("sinxcosydot").checked) arrayF.push(fsinxcosydot);
                if(document.getElementById("sinycosxdot").checked) arrayF.push(fsinycosxdot);

                if(arrayF.length>0)
                    input_functions = arrayF;

            }
            function shouldUseInput(value) {
                input_transformation = value;
                hideUiThings();
                showUiThings();
            }
            function shouldUseTimer(value) {
                use_timer = value;
                hideUiThings();
                showUiThings();
            }

            function copyFunction() {
                if(kernelid!==2){
                    document.getElementById("myTooltip").innerHTML = "No formula to copy";
                    return;
                }
                let copyText = document.getElementById("fakeInputFormula");
                let fake = $("#fakeInputFormula");
                fake.show();
                copyText.select();
                document.execCommand("copy");
                fake.hide();

                let tooltip = document.getElementById("myTooltip");
                tooltip.innerHTML = "Copied: " + copyText.value;

                let eq = copyText.value;

                while(eq.indexOf("+")!== -1 )
                    eq = eq.replace("+","%2B");

                link = "https://www.wolframalpha.com/input/?i="+eq;

            }
            function outFunc() {
                let tooltip = document.getElementById("myTooltip");
                tooltip.innerHTML = "Copy to clipboard";
            }
            function openLink(){
                copyFunction();
                window.open(link);
            }

        </script>

        <script type="text/javascript">
            function getFormula() {
                return document.getElementById("fakeInputFormula").value;
            }
            function formatData(data,labels) {
                let formatted_data="";
                let n = data.length;
                let m = data[0].length+1;
                let withIndex = false;
                for(let i=0;i<n;i++){
                    if(withIndex)
                        formatted_data+=i+":";
                    formatted_data+="[";
                    for(let j=0;j<m;j++){
                        if(j===m-1) //se √® l'ultimo valore ci metto il label
                            formatted_data += labels[i];
                        else
                            formatted_data += data[i][j]+",";
                    }
                    formatted_data+="]\n";
                }
                return formatted_data;
            }
            function download(data,name,type) {
                // create the text file as a Blob:
                if(name!==equation_placeholder){
                    if(name === training_placeholder)
                        data = formatData(data,labels);
                    else
                        data = formatData(data,labelstest);
                }
                let blob = new Blob([data],{type: type});

                let url = URL.createObjectURL(blob),
                    div = document.createElement("div"),
                    anch = document.createElement("a");

                document.body.appendChild(div);
                div.appendChild(anch);

                anch.innerHTML = "&nbsp;";
                div.style.width = "0";
                div.style.height = "0";
                anch.href = url;
                anch.download = name;

                let ev = new MouseEvent("click",{});
                anch.dispatchEvent(ev);
                document.body.removeChild(div);
            }
            function downloadConfig() {
                let config = {
                    datasetID: datasetID,
                    N:N,
                    Ntest: Ntest,
                    data: data,
                    labels: labels,
                    datatest: datatest,
                    labelstest: labelstest,
                    use_timer: use_timer,
                    input_transformation: input_transformation,
                    inputs: [],
                    kernelid: kernelid,
                    Degree: Degree,
                };
                let inputList = document.getElementsByClassName("inputF");
                let id = 0;
                for(let i=0;i<inputList.length;i++){
                    id = inputList[i].id;
                    if(document.getElementById(id).checked)
                        config.inputs.push(id);
                }

                config = JSON.stringify(config);
                let blob = new Blob([config],{type: jsonType});

                let url = URL.createObjectURL(blob),
                    div = document.createElement("div"),
                    anch = document.createElement("a");

                document.body.appendChild(div);
                div.appendChild(anch);

                anch.innerHTML = "&nbsp;";
                div.style.width = "0";
                div.style.height = "0";
                anch.href = url;
                anch.download = "config";

                let ev = new MouseEvent("click",{});
                anch.dispatchEvent(ev);
                document.body.removeChild(div);
            }
            function uploadConfig(evt) {
                let files = evt.target.files; // FileList object
                //reset user data variables
                user_data = [];
                user_labels = [];
                //pick the first file
                let f = files[0];
                if (!f.type.match('application/json')) {
                    console.info("not");
                    return;
                }

                let reader = new FileReader();

                // Closure to capture the file information.
                reader.onload = (function(theFile) {
                    return function(e) {
                        let res = e.target.result;
                        let json = JSON.parse(res);
                        loadConfig(json);
                    };
                })(f);

                // Read in the image file as text
                reader.readAsText(f);
            }
            function uploadData(evt) {
                let files = evt.target.files; // FileList object
                //reset user data variables
                user_data = [];
                user_labels = [];
                //pick the first file
                let f = files[0];
                if (!f.type.match('application/json')) {
                    console.info("not");
                    return;
                }

                let reader = new FileReader();

                // Closure to capture the file information.
                reader.onload = (function(theFile) {
                    return function(e) {
                        let scale = 1;
                        let offsetx = 0;
                        let offsety = 0;
                        let res = e.target.result;
                        //*************************************************************************
                        // let json = JSON.parse(res);
                        // console.info(json);
                        let i = res.search("\n");
                        let line = res.substring(0,i);

                        let x,y,label;
                        let comma,comma2;
                        while(line.length>0){
                            comma = line.indexOf(",");
                            comma2 = line.indexOf(",",comma+1);
                            x = line.substring(1,comma);
                            y = line.substring(comma+1,comma2);
                            label = line.substring(comma2+1,i-1);
                            user_data.push([parseFloat(x)/scale-offsetx,parseFloat(y)/scale-offsety]);
                            user_labels.push(parseFloat(label));
                            i = res.indexOf("\n");
                            if(i>0) {
                                line = res.substring(0, i);
                                res = res.substring(i + 1, res.length);
                            }
                            else line = "";
                        }
                        // replace of data
                        setDataSet(-1);
                        execute();
                    };
                })(f);

                // Read in the image file as text
                reader.readAsText(f);

            }
            function setUploadDataset() {
                document.getElementById('uploadData').click();
            }
            function setUploadConfig() {
                document.getElementById('uploadConfig').click();
            }
        </script>
        <!-- draw functions -->
        <script src="./js/draw.js"></script>
        <!-- MouseClick -->
        <script src="./js/events.js"></script>
        <!-- ui functions -->
        <script type="text/javascript" src="js/ui.js"></script>
        <!-- jquery/set functions -->
        <script type="text/javascript" src="js/functions.js"></script>
    </head>

    <body onLoad="onLoad()"> <!-- 24 FPS -->
        <div id="info">
            <br>
            <h1>Support Vector Machine in Javascript</h1>
            <p>
                Uses SMO algorithm. Find this code on <a href="https://github.com/davide97g/svmjs">Github</a> <br />
                This version is based on the work of Andrej Karpathy. Find his code on <a href="https://github.com/karpathy/svmjs">Github</a>.
            </p>
            <div id="execution">
                <audio id="hereWeGo">
                    <source src="./audio/here_we_go.mp3" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
                <audio id="getReady">
                    <source src="./audio/get_ready.mp3" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
                <button type="button" class="btn" id="gobtn" onclick="execute()">Execute</button>
                <button type="button" class="btn" id="testbtn" onclick="test()">Test</button>
                <button type="button" class="btn" id="cleanbtn" onclick="clean()">Clean</button>
                <br/>
                <button id="downloadConfig" class="btn action" onclick="downloadConfig()">Download Config</button>
                <button id="downloadData" class="btn action" onclick="download(data,training_placeholder,jsonType)">Download Data</button>
                <button id="downloadTest" class="btn action" onclick="download(datatest,test_placeholder,textType)">Download Test</button>
                <button class="btn action" onclick="setUploadDataset()">Upload DataSet</button>
                <button class="btn action" onclick="setUploadConfig()">Upload Configuration</button>
                <input type="file" id="uploadData" name="files[]">
                <input type="file" id="uploadConfig" name="files[]">
                <script>
                    document.getElementById('uploadData').addEventListener('change', uploadData, false);
                    document.getElementById('uploadConfig').addEventListener('change', uploadConfig, false);
                </script>
            </div>
        </div>

        <div id="progress-wrap" class="progress-wrap progress">
            <div id="progress-bar" class="progress-bar progress"></div>
        </div>

        <button type="button" class="btn visibility" id="draw_tab_btn" onclick="setTabVisibility(id,!draw_tab)">Draw</button>
        <div id="draw">
            <canvas class="card card-1 nopadding" id="canvasData" width="500px" height="500px">Browser not supported for Canvas. Get a real browser.
            </canvas>
            <canvas class="card card-1 nopadding" id="canvasResult" width="500px" height="500px">Browser not supported for Canvas. Get a real browser.
            </canvas>
        </div>

        <button type="button" class="btn visibility" id="statistics_tab_btn" onclick="setTabVisibility(id,!statistics_tab)">Statistics</button>
        <div class="card card-1" id="statistics">
            <div class="card card-1" id="statistics_score">
                    <h2>Scoreboard</h2>
                    <div id="scoreboard"></div>
</div>
            <div class="card card-1" id="statistics_svm">
                <h2>Formula Linear</h2>
                <input type="text" id ="fakeInputFormula">
                <div class="card card-1 blue" id="formulaL">---</div>
                <div id="actions">
                    <div class="tooltip">
                        <button class="btn" onclick="copyFunction()" onmouseout="outFunc()">
                            <span class="tooltiptext" id="myTooltip">Copy to clipboard</span>
                            Copy equation
                        </button>
                    </div>
                    <button class="btn" id="btnLink" onclick="openLink()">Open in Wolframalpha</button>
                    <button id="download" class="btn action" onclick="download({data:getFormula(),labels:[]},equation_placeholder,textType)">Download</button>
                </div>
                <h4>Dimensions</h4>
                <h2 id ="nDim">---</h2>
                <h4>Support Vector</h4>
                <h2 id ="nSV">---</h2>
                <h4>Training Time</h4>
                <h2 id ="time">---</h2>
            </div>
            <div class="card card-1" id="statisticsTraining">
                <h2>Statistics Training</h2>
                <table class="card card-1" id="CMtable">
                    <thead>
                    <tr>
                        <th colspan="2">Confusion Matrix</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="tp">-</td>
                        <td id="fp">-</td>
                    </tr>
                    <tr>
                        <td id="fn">-</td>
                        <td id="tn">-</td>
                    </tr>
                    </tbody>
                </table>
                <div class="card card-1 stats">
                    <div>
                        Precision:
                        <span class="value" id="precision">-</span>
                        %
                    </div>
                    <div>
                        Recall:
                        <span class="value" id="recall">-</span>
                        %
                    </div>
                    <div>
                        Accurancy:
                        <span class="value" id="accurancy">-</span>
                        %
                    </div>
                    <div>
                        Specificity:
                        <span class="value" id="specificity">-</span>
                        %
                    </div>
                    <div>
                        F-Measure:
                        <span class="value" id="fmeasure">-</span>
                        %
                    </div>
                </div>
            </div>
            <div class="card card-1" id="statisticsTest">
                <h2>Statistics Test</h2>
                <table class="card card-1" id="CMtableTest">
                    <thead>
                    <tr>
                        <th colspan="2">Confusion Matrix Test</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="tp2">-</td>
                        <td id="fp2">-</td>
                    </tr>
                    <tr>
                        <td id="fn2">-</td>
                        <td id="tn2">-</td>
                    </tr>
                    </tbody>
                </table>
                <div class="card card-1 stats">
                    <div>
                        Precision:
                        <span class="value" id="precision2">-</span>
                        %
                    </div>
                    <div>
                        Recall:
                        <span class="value" id="recall2">-</span>
                        %
                    </div>
                    <div>
                        Accurancy:
                        <span class="value" id="accurancy2">-</span>
                        %
                    </div>
                    <div>
                        Specificity:
                        <span class="value" id="specificity2">-</span>
                        %
                    </div>
                    <div>
                        F-Measure:
                        <span class="value" id="fmeasure2">-</span>
                        %
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn visibility" id="options_tab_btn" onclick="setTabVisibility(id,!options_tab)">Options</button>
        <div class="card card-1" id="options">
            <div class="card card-1" id="execution_options">
                <h3>Execution Options</h3>
                <div class="card card-1" id="algoritm_options">
                    <h3>Training Algorithm</h3>
                    <label class="container big" id="karpathy_container">Karpathy
                        <input type="radio" name="algorithm" id="karpathy" checked>
                        <span class="checkmark"></span>
                    </label>
                    <label class="container big" id="platt_container">John Platt
                        <input type="radio" name="algorithm" id="platt">
                        <span class="checkmark"></span>
                    </label>
                </div>
                <div class="card card-1" id="timer_options">
                    <button type="button" class="btn" id="use_timer_btn" onclick="shouldUseTimer(!use_timer)">Use Timer</button>
                    <!--<label class="container big" id="use_timer_container">Use Timer
                        <input type="checkbox" id="use_timer" checked>
                        <span class="checkmark"></span>
                    </label> -->
                    <div id="s12" class="slider_container">
                        <h3 id="updateFrequencyport">Update Frequency = 100 ms</h3>
                        <div id="slider12"></div>
                    </div>
                    <div id="s13" class="slider_container">
                        <h3 id="stepsFrequencyport">Steps Frequency = 10 steps</h3>
                        <div id="slider13"></div>
                    </div>
                </div>

            </div>
            <div class="card card-1" id="kernels">
                <h3>Kernels</h3>
                <button id="rbfk" class="btn" onclick="changeKernel(1)">RBF</button>
                <button id="poly" class="btn" onclick="changeKernel(2)">Polynomial</button>
                <button type="button" class="btn" id="input_transformations" onclick="shouldUseInput(!input_transformation)">Extra Input</button>
                <div class="card card-1" id="input">
                    <div id="input_choice">
                        <label class="container small ">x^2
                            <input type="checkbox" class="inputF" id="x2">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container small ">y^2
                            <input type="checkbox" class="inputF" id="y2">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container small ">x^3
                            <input type="checkbox" class="inputF" id="x3">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container small ">y^3
                            <input type="checkbox" class="inputF" id="y3">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container medium ">x^2+y^2
                            <input type="checkbox" class="inputF" id="x2y2">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container medium ">x^2-y^2
                            <input type="checkbox" class="inputF" id="x2_y2">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container medium ">x*y
                            <input type="checkbox" class="inputF" id="xy">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container small ">sin(x)
                            <input type="checkbox" class="inputF" id="sinx">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container small ">cos(x)
                            <input type="checkbox" class="inputF" id="cosx">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container small ">sin(y)
                            <input type="checkbox" class="inputF" id="siny">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container small ">cos(y)
                            <input type="checkbox" class="inputF" id="cosy">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container big ">sin(x)+cos(y)
                            <input type="checkbox" class="inputF" id="sinxcosy">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container big ">sin(y)+cos(x)
                            <input type="checkbox" class="inputF" id="sinycosx">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container big ">sin(x)*cos(y)
                            <input type="checkbox" class="inputF" id="sinxcosydot">
                            <span class="checkmark"></span>
                        </label>
                        <label class="container big ">sin(y)*cos(x)
                            <input type="checkbox" class="inputF" id="sinycosxdot">
                            <span class="checkmark"></span>
                        </label>
                        <button type="button" class="btn" id="bestbtn" onclick="best()"><strong>Sort out the Best-Single-Input?</strong></button>
                    </div>
                </div>
            </div>
            <div class="card card-1" id="evalutation">
                <h3>Evaluation functions</h3>
                <button id="knn" class="btn" onclick="changeKernel(3)">KNN</button>
                <button id="rbf" class="btn" onclick="changeKernel(4)">RBF</button>
            </div>
            <div id="optimization">
                <h4>Optimization </h4>
                <label for="ssca">SSCA</label><input type="checkbox" id="ssca"/>
            </div>

            <div class="card card-1" id="distances">
                <h3>Distances</h3>
                <button id="min" class="btn" onclick="changeDistance(0)">Minkowski</button>
                <button id="che" class="btn" onclick="changeDistance(1)">Chebyshev</button>
                <button id="maha" class="btn" onclick="changeDistance(2)">Mahalanobis</button>
            </div>
            <div class="card card-1" id="kmeans" >
                <h3>K-Means</h3>
                <div class="card card-1" id="kmeans-mode">
                    <h3>Mode</h3>
                    <label class="container big">Algorithm
                        <input type="radio" name="kmeans" id="calculate_kmeans_points" value="algorithm" checked>
                        <span class="checkmark"></span>
                    </label>
                    <label class="container big">User
                        <input type="radio" name="kmeans" id="user_kmeans_points" value="user">
                        <span class="checkmark"></span>
                    </label>
                </div>
                <div class="card card-1" id="kmeans-options">
                    <h3>Options</h3>
                    <label class="container medium">Draw
                        <input type="checkbox" id="draw_kmeans_points">
                        <span class="checkmark"></span>
                    </label>
                    <label class="container medium">As Data
                        <input type="checkbox" id="kmdata">
                        <span class="checkmark"></span>
                    </label>
                    <button id="resetKmeans" class="btn" onclick="cleanKmeans()">Clean</button>
                </div>
            </div>
            <div class="card card-1" id="datasets">
                <h3>Datasets</h3>
                <div id="s0" class="slider_container">
                    <h3 id="nport">N = 100</h3>
                    <div id="slider0"></div>
                </div>
                <div id="s11" class="slider_container">
                    <h3 id="ntestport">N Test = 100</h3>
                    <div id="slider11"></div>
                </div>
                <button class="btn " id="databtn1" onclick="setDataSet(1),execute()">Random</button>
                <button class="btn " id="databtn2" onclick="setDataSet(2),execute()">Circle</button>
                <button class="btn " id="databtn3" onclick="setDataSet(3),execute()">ExclusiveOr</button>
                <button class="btn " id="databtn4" onclick="setDataSet(4),execute()">Gaussian</button>
                <button class="btn " id="databtn5" onclick="setDataSet(5),execute()">Spiral</button>
                <button class="btn " id="databtn6" onclick="setDataSet(6),execute()">Multi Circle</button>
                <button class="btn " id="databtn7" onclick="setDataSet(7),execute()">V-Stripes</button>
                <button class="btn " id="databtn8" onclick="setDataSet(8),execute()">H-Stripes</button>
            </div>
            <div class="card card-1" id="values">
                <h3>Values</h3>
                <div id="s1" class="slider_container">
                    <h3 id="creport">C = 1.0</h3>
                    <div id="slider1"></div>
                </div>
                <div id="s2" class="slider_container">
                    <h3 id="sigreport">RBF Kernel sigma = 1.0 </h3>
                    <div id="slider2"></div>
                </div>
                <div id="s3" class="slider_container">
                    <h3 id="degport">Polynomial Kernel degree = 1</h3>
                    <div id="slider3"></div>
                </div>
                <div id="s4" class="slider_container">
                    <h3 id="infport">Polynomial Kernel influence = 0</h3>
                    <div id="slider4"></div>
                </div>
                <div id="s5" class="slider_container">
                    <h3 id="ubport">Upper bound = 0.5</h3>
                    <div id="slider5"></div>
                </div>
                <div id="s6" class="slider_container">
                    <h3 id="kport">K: 1</h3>
                    <div id="slider6"></div>
                </div>
                <div id="s7" class="slider_container">
                    <h3 id="pport">Minkowski with P: 2</h3>
                    <div id="slider7"></div>
                </div>
                <div id="s8" class="slider_container">
                    <h3 id="epsilonport">Epsilon : 0.1</h3>
                    <div id="slider8"></div>
                </div>
                <div id="s9" class="slider_container">
                    <h3 id="kmeans1port">K1 (Means) : 3</h3>
                    <div id="slider9"></div>
                </div>
                <div id="s10" class="slider_container">
                    <h3 id="kmeans2port">K2 (Means) : 3</h3>
                    <div id="slider10"></div>
                </div>
            </div>
        </div>
    </body>
</html>
