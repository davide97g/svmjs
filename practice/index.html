<!DOCTYPE html>
<html lang="it">
    <head>
        <title>SVM Javascript</title>
        <link type="text/css" href="./jqueryui/css/ui-lightness/jquery-ui-1.8.21.custom.css" rel="Stylesheet" />
        <link type="text/css" rel="stylesheet" href="style/style.css"/>
        <script type="text/javascript" src="./jqueryui/js/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="./jqueryui/js/jquery-ui-1.8.21.custom.min.js"></script>
        <script src="./npg_include/npgmain.js"></script>
        <script src="./npg_include/drawTest.js"></script>

        <script src="../lib/stats.js"></script>
        <script src="../lib/utils.js"></script>
        <script src="../lib/kernels.js"></script>

        <script src="./js/kmeans.js"></script>
        <script src="../lib/svm.js"></script>
        <script src="../lib/svmo.js"></script>

        <script type="text/javascript" src="./js/generator.js"></script>
        <!-- Declaration and initialization -->
        <script type="text/javascript">

        /*
        This demo includes npg library (notpygamejs) that I wrote a while ago. It can
        be found on my Github page (https://github.com/karpathy/notpygamejs). It's a
        quick and dirty canvas wrapper that has some helped functions I use often.
        It's main use is to contain a main loop and expose methods update(), draw(),
        as well as some events keyUp(), mouseClick() etc.
        */

        let N = 100; //number of data points
        let Ntest = 100;
        let data = new Array(N);
        let labels = new Array(N);
        let datatest = new Array(N);
        let labelstest = new Array(N);
        let dataOLD = [];
        let labelsOLD = [];
        let wb; // weights and offset structure
        let ss= 40.0; // scaling factor for drawing
        let svm= new svmjs.SVM();
        let svmo = new svmojs.SVMO();

        let rbfKernelSigma = 0.5;
        let svmC = 1.0;
        let memo = false;
        let x2 = false;
        let y2 = false;

        let kernelid= 4;
        let Degree = 2;
        let Influence = 0;
        let ssca = false;
        let ub = 0.5;
        let K = 1; //for KNN
        let P = 2; //for minkowski
        let v; //array of variances
        let distanceid = 0; //for distances in KNN evalutations
        let datasetID = 1; //initially random
        let Epsilon = 0.1; //for rbf function evaluation
        let drawKmeansPoints = true; //only for the drawing thing
        let Km1 = 3; //K for kmeans
        let Km2 = 3; //K for kmeans
        let means;
        let KMdata = false; //use or not Kmeans as data
        let useTest = false; //show the tests
        let density = 2; //drawing canvas points
        let dataset_modified = true;

        let canvasResult = "canvasResult";
        let canvasData = "canvasData";

        function setDataSet(id) {
            if(datasetID !== id){
                datasetID = id;
                dataset_modified = true;
            }
            if(id===1){
                let res = randomData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===2){
                let res = circleData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===3){
                let res = exclusiveOrData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===4){
                let res = gaussianData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===5){
                let res = spiralData(N);
                data = res.data;
                labels = res.labels;
            }
            else if(id===6){
                let res = circleMultipleData(N);
                data = res.data;
                labels = res.labels;
            }
            setTrainingSet(datasetID);
        }
        function setTrainingSet(id) {
            if(id===1){
                let res = randomData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===2){
                let res = circleData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===3){
                let res = exclusiveOrData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===4){
                let res = gaussianData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===5){
                let res = spiralData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
            else if(id===6){
                let res = circleMultipleData(Ntest);
                datatest = res.data;
                labelstest = res.labels;
            }
        }

        function retrainSVM() {

            console.info("üêµ DATASET "+datasetID);

            if(kernelid === 0) {
                kernelid = 2;
                Degree = 1;
                retrainSVM();
            }
            else if(kernelid === 1) {
                ssca = document.getElementById("ssca").checked;
                svm.train(data, labels, { kernel: 'rbf', rbfsigma: rbfKernelSigma, C: svmC, SSCA: ssca, UB: ub, memoize: memo});
            }
            else if(kernelid === 2){
                ssca = document.getElementById("ssca").checked;
                svm.train(data, labels, { kernel: 'poly', degree: Degree, influence: Influence, C: svmC, SSCA: ssca, UB: ub, memoize: memo, x2: x2,y2:y2,});
                if(Degree === 1)
                    wb = svm.getWeights();
            }
            else if(kernelid === 3){
                console.info("\tKNN: "+K);
                console.info("\tDISTANCE: "+distanceF.name);
                if(distanceid===0){
                    console.info("\tP = "+P);
                }
                else if(distanceid === 2){ //mahalanobis
                    v = variance(); //calcolo una volta sola per aggiornamento di data set
                }
            }
            else if(kernelid === 4){
                console.info("\tRBF");
            }
        }

        function myinit(){
            setDataSet(2);
        }
        function myinitTest(){}

        function KMEANS(data) {
            console.info("\tKMEANS");
            let separated = separateData(data);
            let kmeans1 = new KMeans({
                canvas: document.getElementById('canvasData'),
                data: separated[0],
                k: Km1,
                p: 1
            });
            let kmeans2 = new KMeans({
                canvas: document.getElementById('canvasData'),
                data: separated[1],
                k: Km2,
                p: 1
            });

            means = new Array(2);
            means[0] = kmeans1.means;
            means[1] = kmeans2.means;
            let L1 = means[0].length;
            let L2 = means[1].length;
            let L = L1+L2;
            let newData = new Array(L);
            let newLabels = new Array(L);
            for(let i=0;i<L1;i++){
                newData[i] = means[0][i];
                newLabels[i] = 1;
            }
            for(let i=L1;i<L;i++) {
                newData[i] = means[1][i-L1];
                newLabels[i] = -1;
            }
            return {
                data: newData,
                labels: newLabels
            };
        }
        function separateData(data) {
            let res = new Array(2);
            res[0] = [];
            res[1] = [];
            for(let i=0;i<data.length;i++){
                if(labels[i]===1)
                    res[0].push(data[i]);
                else res[1].push(data[i]);
            }
            return res;
        }

        </script>

        <!-- distances functions (minkowski, chebyshev, mahalanobis) -->
        <script type="text/javascript" src="js/distances.js"></script>

        <!-- evaluations functions (KNN and RBF) -->
        <script type="text/javascript" src="js/evaluations.js"></script>

        <!-- main functions -->
        <script type="text/javascript">

            function update(){
                console.info("UPDATE");
                //check values on checkbox
                useTest = document.getElementById("test").checked;
                x2 = document.getElementById("x2").checked;
                y2 = document.getElementById("y2").checked;
                drawKmeansPoints = document.getElementById("draw_kmeans_points").checked;
                let value = document.getElementById("kmdata").checked;
                //eseguo il calcolo dei centri kmeans
                let res = KMEANS(data);
                //se √® stato modificato il dataset
                if(dataset_modified){
                    dataset_modified = false;
                    document.getElementById("kmdata").checked = false;
                    if(KMdata)
                        N = dataOLD.length;
                    else N = data.length;
                    KMdata = false;
                    console.info("RESET "+N);
                    setDataSet(datasetID);

                }
                else {
                    if (value !== KMdata) {
                        if (value) {
                            console.info("STORE data");
                            dataOLD = data;
                            labelsOLD = labels;
                        } else {
                            console.info("RESTORE data");
                            data = dataOLD;
                            labels = labelsOLD;
                        }
                    }
                    KMdata = value;
                    if (KMdata) {
                        console.info("OVERWRITE data");
                        data = res.data;
                        labels = res.labels;
                    }

                    //update limits
                    N = data.length;
                }
                //hide and show buttons/options
                hideUiThings();
                showUiThings();
            }

            function execute() {
                console.clear();
                console.info("üî® EXECUTE");
                update();
                //setDataSet(datasetID);
                retrainSVM();
                draw();
            }

            function test() {
                console.info("üß™ TEST");
                if(!useTest) {
                    document.getElementById("test").checked = true;
                    useTest = true;
                }
                hideUiThings();
                showUiThings();
                let app = ctx;
                ctx = ctxTest; //substitute
                ctx.lineWidth = 1;
                drawTest(ctxTest);
                ctx = app; //return to normal
            }

        </script>

        <script src="./js/draw.js"></script>

        <!-- MouseClick -->
        <script src="./js/events.js"></script>

        <!-- ui functions -->
        <script type="text/javascript" src="js/ui.js"></script>

        <!-- jquery/set functions -->
        <script type="text/javascript" src="js/functions.js"></script>

    </head>

    <body onLoad="NPGinit(10,canvasData), drawTestInit(10,canvasResult),execute()"> <!-- 24 FPS -->
        <div id="info">
            <br /><h1>Support Vector Machine in Javascript</h1>
            <p>
                Uses SMO algorithm. Find this code on <a href="https://github.com/davide97g/svmjs">Github</a> <br />
                This version is based on the work of Andrej Karpathy. Find his code on <a href="https://github.com/karpathy/svmjs">Github</a>.
            </p>
        </div>
        <div id="options">
            <h3>Instructions</h3>
            <div>
                <strong>Mouse click</strong>: add red data point<br />
                <strong>Shift + mouse click</strong>: add green data point<br />
            </div>
            <h3>Execute</h3>
            <div>
                <button type="button" class="btn" id="gobtn" onclick="execute()">Execute</button>
                <button type="button" class="btn" id="testbtn" onclick="test()">Test</button>
            </div>
            <h3>Test</h3>
            <div id="checkboxTest" class="opts">
                <label for="test">Test data</label><input type="checkbox" id="test"/>
            </div>
            <h3>Options</h3>
            <div id="kernels" class="opts">
                <h4>Kernels</h4>
                <button id="rbfk" class="btn" onclick="changeKernel(1)">RBF</button>
                <button id="poly" class="btn" onclick="changeKernel(2)">Polynomial</button>
            </div>
            <div id="optimization" class="opts">
                <h4>Optimization </h4>
                <label for="ssca">SSCA</label><input type="checkbox" id="ssca"/>
                <label for="x2">X^2</label><input type="checkbox" id="x2"/>
                <label for="y2">Y^2</label><input type="checkbox" id="y2"/>
            </div>
            <div id="evalutation" class="opts">
                <h4>Evaluation functions</h4>
                <button id="knn" class="btn" onclick="changeKernel(3)">KNN</button>
                <button id="rbf" class="btn" onclick="changeKernel(4)">RBF</button>
            </div>
            <div id="distances" class="opts">
                <h4>Distances</h4>
                <button id="min" class="btn" onclick="changeDistance(0)">Minkowski</button>
                <button id="che" class="btn" onclick="changeDistance(1)">Chebyshev</button>
                <button id="maha" class="btn" onclick="changeDistance(2)">Mahalanobis</button>
            </div>
            <div id="kmeans" class="opts">
                <label for="draw_kmeans_points">Draw Kmeans Centers</label><input type="checkbox" id="draw_kmeans_points"/>
                <label for="kmdata">Use Kmeans as Data</label><input type="checkbox" id="kmdata"/>
            </div>
            <h3>Datasets</h3>

            <div id="s0" class="slider_container">
                <span id="nport">N = 100</span>
                <div id="slider0"></div>
            </div>
            <div id="s11" class="slider_container">
                <span id="ntestport">N test = 100</span>
                <div id="slider11"></div>
            </div>

            <div class="datasets">
                <button class="keys btn orange" id="databtn1" onclick="setDataSet(1),execute()">Random</button>
                <button class="keys btn blue" id="databtn2" onclick="setDataSet(2),execute()">Circle</button>
                <button class="keys btn yellow" id="databtn3" onclick="setDataSet(3),execute()">ExclusiveOr</button>
                <button class="keys btn purple" id="databtn4" onclick="setDataSet(4),execute()">Gaussian</button>
                <button class="keys btn orange" id="databtn5" onclick="setDataSet(5),execute()">Spiral</button>
                <button class="keys btn blue" id="databtn6" onclick="setDataSet(6),execute()">Multi Circle</button>
            </div>

            <div id="values">
                <h3>Values</h3>
                <div id="s1" class="slider_container">
                    <span id="creport">C = 1.0</span>
                    <div id="slider1"></div>
                </div>
                <div id="s2" class="slider_container">
                    <span id="sigreport">RBF Kernel sigma = 1.0 </span>
                    <div id="slider2"></div>
                </div>
                <div id="s3" class="slider_container">
                    <span id="degport">Polynomial Kernel degree = 2</span>
                    <div id="slider3"></div>
                </div>
                <div id="s4" class="slider_container">
                    <span id="infport">Polynomial Kernel influence = 0</span>
                    <div id="slider4"></div>
                </div>
                <div id="s5" class="slider_container">
                    <span id="ubport">Upper bound = 0.5</span>
                    <div id="slider5"></div>
                </div>
                <div id="s6" class="slider_container">
                    <span id="kport">K: 1</span>
                    <div id="slider6"></div>
                </div>
                <div id="s7" class="slider_container">
                    <span id="pport">Minkowski with P: 2</span>
                    <div id="slider7"></div>
                </div>
                <div id="s8" class="slider_container">
                    <span id="epsilonport">Epsilon : 0.1</span>
                    <div id="slider8"></div>
                </div>
                <div id="s9" class="slider_container">
                    <span id="kmeans1port">K1 (Means) : 3</span>
                    <div id="slider9"></div>
                </div>
                <div id="s10" class="slider_container">
                    <span id="kmeans2port">K2 (Means) : 3</span>
                    <div id="slider10"></div>
                </div>
            </div>
        </div>
        <div id="draw">
            <canvas id="canvasData" width="400px" height="400px">Browser not supported for Canvas. Get a real browser.
            </canvas>
            <canvas id="canvasResult" width="400px" height="400px">Browser not supported for Canvas. Get a real browser.
            </canvas>
        </div>
        <div id="statistics">
            <div id="statisticsTraining">
                <h3>Statistics Training</h3>
                <table id="CMtable">
                    <thead>
                    <tr>
                        <th colspan="2">Confusion Matrix</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="tp">-</td>
                        <td id="fp">-</td>
                    </tr>
                    <tr>
                        <td id="fn">-</td>
                        <td id="tn">-</td>
                    </tr>
                    </tbody>
                </table>
                <div class="stats">
                    <div>
                        Precision:
                        <span class="value" id="precision">-</span>
                        %
                    </div>
                    <div>
                        Recall:
                        <span class="value" id="recall">-</span>
                        %
                    </div>
                    <div>
                        Accurancy:
                        <span class="value" id="accurancy">-</span>
                        %
                    </div>
                    <div>
                        Specificity:
                        <span class="value" id="specificity">-</span>
                        %
                    </div>
                    <div>
                        F-Measure:
                        <span class="value" id="fmeasure">-</span>
                        %
                    </div>
                </div>
            </div>
            <div id="statisticsTest">
                <h3>Statistics Test</h3>
                <table id="CMtableTest">
                    <thead>
                    <tr>
                        <th colspan="2">Confusion Matrix Test</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="tp2">-</td>
                        <td id="fp2">-</td>
                    </tr>
                    <tr>
                        <td id="fn2">-</td>
                        <td id="tn2">-</td>
                    </tr>
                    </tbody>
                </table>
                <div class="stats">
                    <div>
                        Precision:
                        <span class="value" id="precision2">-</span>
                        %
                    </div>
                    <div>
                        Recall:
                        <span class="value" id="recall2">-</span>
                        %
                    </div>
                    <div>
                        Accurancy:
                        <span class="value" id="accurancy2">-</span>
                        %
                    </div>
                    <div>
                        Specificity:
                        <span class="value" id="specificity2">-</span>
                        %
                    </div>
                    <div>
                        F-Measure:
                        <span class="value" id="fmeasure2">-</span>
                        %
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
